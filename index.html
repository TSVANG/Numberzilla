<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ß–∏—Å–ª–æ–≤–∞—è –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ VK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; background-color: #FDFBF8; color: #8B5A2B;
            touch-action: none; overflow: hidden;
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
        }
        #game-wrapper { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
        #game-container {
            background: #F7F2EC; border: 1px solid #EADDCD; position: relative;
            overflow-y: auto; overflow-x: hidden;
            scrollbar-width: thin; scrollbar-color: #C0A78E #F7F2EC;
        }
        #game-container::-webkit-scrollbar { width: 6px; }
        #game-container::-webkit-scrollbar-track { background: #F7F2EC; }
        #game-container::-webkit-scrollbar-thumb { background-color: #C0A78E; border-radius: 6px; border: 2px solid #F7F2EC; }
        
        #game-board { display: grid; grid-template-columns: repeat(9, 1fr); gap: 0; }
        .grid-cell {
            aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center;
            font-size: clamp(1rem, 5vw, 1.5rem); font-weight: 600; cursor: pointer;
            transition: all 0.2s ease-in-out; background-color: transparent;
            position: relative; border: 1px solid #EADDCD;
        }
        .grid-cell .number-display {
             background-color: #FDFBF8; border: 1px solid #EADDCD; border-radius: 4px;
             width: 90%; height: 90%; display: flex; justify-content: center; align-items: center;
             transition: all 0.2s ease-in-out; z-index: 2;
        }
        .grid-cell.selected .number-display {
            background-color: #FCE9D7; transform: scale(1.05); box-shadow: 0 0 0 2px #E5B98F;
        }
        .grid-cell.empty .number-display { opacity: 0; pointer-events: none; }
        .ghost-number {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #DCD1C4; z-index: 1;
        }
        .btn-icon {
            background-color: #EFE8E1; color: #8B5A2B; transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); position: relative;
        }
        .btn-icon:hover { background-color: #E5DCD1; transform: translateY(-2px); }
        .btn-icon:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hint-glow .number-display { animation: glow 1.5s ease-in-out 2; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 0 2px #F9A826; } 50% { box-shadow: 0 0 15px 5px #F9A826; } }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #FDFBF8; padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 400px;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .anim-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin: 8px auto; width: 120px; }
        .anim-cell { width: 25px; height: 25px; background-color: #EFE8E1; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; position: relative;}
    </style>
</head>
<body class="flex items-center justify-center p-2 sm:p-4" oncontextmenu="return false;">
    <div id="game-wrapper" class="w-full max-w-md mx-auto pb-[50px]"> <!-- –û—Ç—Å—Ç—É–ø –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ -->
        <header class="text-center mb-2 sm:mb-4 flex justify-between items-center px-1 flex-shrink-0">
            <div class="w-1/3 text-left">
                <h1 id="stage-title" class="text-xl sm:text-2xl font-bold text-[#D99B66]">–≠—Ç–∞–ø 1</h1>
            </div>
            <div class="w-1/3 text-center">
                <div class="text-lg sm:text-xl font-bold text-[#D99B66]">–û—á–∫–∏: <span id="score">0</span></div>
            </div>
            <div class="w-1/3 text-right">
                <button id="stats-btn" class="w-12 h-12 sm:w-14 sm:h-14 inline-flex items-center justify-center rounded-xl sm:rounded-2xl btn-icon text-3xl">üèÜ</button>
            </div>
        </header>

        <main id="game-container" class="rounded-lg shadow-sm flex-grow overflow-y-auto">
            <div id="game-board"></div>
        </main>
        
        <div id="message-box" class="text-center h-6 sm:h-8 my-2 sm:my-4 text-base sm:text-lg font-semibold text-red-500 flex-shrink-0"></div>

        <footer class="grid grid-cols-4 gap-2 sm:gap-4 items-center flex-shrink-0 mt-2">
            <button id="restart-btn" class="w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center rounded-xl sm:rounded-2xl btn-icon">
                <svg class="w-6 h-6 sm:w-8 sm:h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
            </button>
            <button id="hint-btn" class="relative w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center rounded-xl sm:rounded-2xl text-3xl sm:text-4xl btn-icon">
                üí°
                <div id="hint-counter-wrapper" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 sm:h-6 sm:w-6 flex items-center justify-center border-2 border-white">
                    <span id="hint-counter"></span>
                    <svg id="video-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </button>
            <button id="add-rows-btn" class="relative w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center rounded-xl sm:rounded-2xl btn-icon">
                <svg class="w-7 h-7 sm:w-9 sm:h-9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <div id="add-rows-counter" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 sm:h-6 sm:w-6 flex items-center justify-center border-2 border-white"></div>
            </button>
            <button id="help-btn" class="w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center rounded-xl sm:rounded-2xl btn-icon">
                <svg class="w-7 h-7 sm:w-9 sm:h-9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="instructions-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-4">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h2>
            <div class="space-y-4 text-base text-center">
                <p>–£–¥–∞–ª—è–π—Ç–µ –ø–∞—Ä—ã <b>–æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —á–∏—Å–µ–ª</b> (7 –∏ 7) –∏–ª–∏ –¥–∞—é—â–∏—Ö –≤ <b>—Å—É–º–º–µ 10</b> (3 –∏ 7).</p>
                <p>–ü–∞—Ä—ã –º–æ–∂–Ω–æ —É–±–∏—Ä–∞—Ç—å –ø–æ <b>–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏</b>, <b>–≤–µ—Ä—Ç–∏–∫–∞–ª–∏</b> –∏ <b>–¥–∏–∞–≥–æ–Ω–∞–ª–∏</b>, –µ—Å–ª–∏ –º–µ–∂–¥—É –Ω–∏–º–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ü–∏—Ñ—Ä.</p>
            </div>
            <button id="close-instructions-btn" class="mt-6 w-full py-2 px-4 bg-[#F9A826] text-white font-semibold rounded-lg shadow-md hover:bg-[#f9b84c] transition">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>
    
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-3xl font-bold mb-2">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
            <p class="text-lg mb-4">–í–∞—à –∏—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç:</p>
            <p id="final-score" class="text-4xl font-bold text-[#F9A826] mb-6">0</p>
            <button id="play-again-btn" class="w-full py-3 px-4 bg-[#F9A826] text-white font-semibold rounded-lg shadow-md hover:bg-[#f9b84c] transition">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-3xl font-bold mb-6">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="flex justify-around text-lg">
                <div>
                    <p class="text-gray-500">–ü–æ–±–µ–¥</p>
                    <p id="stats-wins" class="text-4xl font-bold">0</p>
                </div>
                <div>
                    <p class="text-gray-500">–õ—É—á—à–∏–π —Å—á–µ—Ç</p>
                    <p id="stats-best-score" class="text-4xl font-bold">0</p>
                </div>
            </div>
            <button id="close-stats-btn" class="mt-8 w-full py-2 px-4 bg-[#F9A826] text-white font-semibold rounded-lg shadow-md hover:bg-[#f9b84c] transition">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="continue-game-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold mb-4">–ù–∞–π–¥–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–≥—Ä–∞</h2>
            <p class="mb-6">–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?</p>
            <div class="flex gap-4">
                <button id="continue-btn" class="w-full py-2 px-4 bg-[#F9A826] text-white font-semibold rounded-lg shadow-md hover:bg-[#f9b84c] transition">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button id="start-new-btn" class="w-full py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const gameBoard = document.getElementById('game-board');
        const addRowsBtn = document.getElementById('add-rows-btn');
        const restartBtn = document.getElementById('restart-btn');
        const hintBtn = document.getElementById('hint-btn');
        const helpBtn = document.getElementById('help-btn');
        const statsBtn = document.getElementById('stats-btn');
        const messageBox = document.getElementById('message-box');
        const stageTitle = document.getElementById('stage-title');
        const scoreDisplay = document.getElementById('score');
        const hintCounterDisplay = document.getElementById('hint-counter');
        const videoIcon = document.getElementById('video-icon');
        const addRowsCounterDisplay = document.getElementById('add-rows-counter');
        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        const instructionsModal = document.getElementById('instructions-modal');
        const closeInstructionsBtn = document.getElementById('close-instructions-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const playAgainBtn = document.getElementById('play-again-btn');
        const statsModal = document.getElementById('stats-modal');
        const statsWinsDisplay = document.getElementById('stats-wins');
        const statsBestScoreDisplay = document.getElementById('stats-best-score');
        const closeStatsBtn = document.getElementById('close-stats-btn');
        const continueGameModal = document.getElementById('continue-game-modal');
        const continueBtn = document.getElementById('continue-btn');
        const startNewBtn = document.getElementById('start-new-btn');

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ---
        let board = [], ghostBoard = [];
        let selectedCell = null;
        const COLS = 9;
        const INITIAL_HINTS = 30;
        const INITIAL_ADD_ROWS = 5;
        let stage = 1, score = 0, hints = INITIAL_HINTS, addRowsCount = INITIAL_ADD_ROWS;
        let stats = { wins: 0, bestScore: 0 };

        // --- VK Bridge ---
        vkBridge.send('VKWebAppInit');
        vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' })
            .catch(error => console.log("Banner Ad Error:", error));

        // --- –•—Ä–∞–Ω–∏–ª–∏—â–µ ---
        async function loadData(key) {
            try {
                const data = await vkBridge.send('VKWebAppStorageGet', { keys: [key] });
                if (data.keys[0].value) {
                    return JSON.parse(data.keys[0].value);
                }
            } catch (error) { console.error(`Failed to load ${key}:`, error); }
            return null;
        }

        async function saveData(key, value) {
            try {
                await vkBridge.send('VKWebAppStorageSet', { key: key, value: JSON.stringify(value) });
            } catch (error) { console.error(`Failed to save ${key}:`, error); }
        }
        
        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
        async function loadStats() {
            const savedStats = await loadData('numberzillaStats');
            if (savedStats) stats = savedStats;
        }
        async function saveStats() {
            if (score > stats.bestScore) stats.bestScore = score;
            await saveData('numberzillaStats', stats);
        }
        function updateStatsModal() {
            statsWinsDisplay.textContent = stats.wins;
            statsBestScoreDisplay.textContent = stats.bestScore;
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã ---
        function getGameState() { return { board, ghostBoard, stage, score, hints, addRowsCount }; }
        function saveCurrentGame() {
            if (board.length > 0) {
                saveData('savedGameState', getGameState());
            } else {
                saveData('savedGameState', null);
            }
        }
        function loadGameState(savedState) {
            board = savedState.board;
            ghostBoard = savedState.ghostBoard;
            stage = savedState.stage;
            score = savedState.score;
            hints = savedState.hints;
            addRowsCount = savedState.addRowsCount;
            stageTitle.textContent = `–≠—Ç–∞–ø ${stage}`;
            updateUI();
            renderBoard();
            checkForPossibleMoves();
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        function generateNumbers(count) { return Array.from({ length: count }, () => Math.floor(Math.random() * 9) + 1); }
        function initGame(isRestart = false) {
            board = generateNumbers(35);
            ghostBoard = Array(board.length).fill(null);
            selectedCell = null;
            stage = 1; score = 0; hints = INITIAL_HINTS; addRowsCount = INITIAL_ADD_ROWS;
            gameOverModal.classList.remove('visible');
            stageTitle.textContent = `–≠—Ç–∞–ø 1`;
            messageBox.textContent = '';
            updateUI();
            renderBoard();
            checkForPossibleMoves();
            saveCurrentGame();
            if (!isRestart && !localStorage.getItem('hasPlayedBeforeVK')) {
                instructionsModal.classList.add('visible');
                localStorage.setItem('hasPlayedBeforeVK', 'true');
            }
        }
        async function startNewLevel() {
            stats.wins++;
            await saveStats();
            stage++;
            hints = INITIAL_HINTS;
            addRowsCount = INITIAL_ADD_ROWS;
            board = generateNumbers(35);
            ghostBoard = Array(board.length).fill(null);
            stageTitle.textContent = `–≠—Ç–∞–ø ${stage}`;
            messageBox.textContent = '–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!';
            updateUI();
            renderBoard();
            checkForPossibleMoves();
            saveCurrentGame();
            setTimeout(() => messageBox.textContent = '', 2000);
        }

        // --- UI ---
        function updateUI() {
            scoreDisplay.textContent = score;
            addRowsCounterDisplay.textContent = addRowsCount;
            addRowsBtn.disabled = addRowsCount <= 0;
            
            if (hints > 0) {
                hintCounterDisplay.textContent = hints;
                videoIcon.classList.add('hidden');
                hintCounterDisplay.classList.remove('hidden');
                hintBtn.disabled = false;
            } else {
                hintCounterDisplay.classList.add('hidden');
                videoIcon.classList.remove('hidden');
                hintBtn.disabled = false;
            }
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ---
        function renderBoard() {
            gameBoard.innerHTML = '';
            board.forEach((num, i) => {
                const cell = document.createElement('div');
                cell.dataset.index = i;
                cell.classList.add('grid-cell');
                const numberDisplay = document.createElement('div');
                numberDisplay.classList.add('number-display');
                if (num !== null) {
                    numberDisplay.textContent = num;
                    cell.addEventListener('click', () => handleCellClick(i));
                } else { cell.classList.add('empty'); }
                if (ghostBoard[i] !== null) {
                    const ghost = document.createElement('div');
                    ghost.classList.add('ghost-number');
                    ghost.textContent = ghostBoard[i];
                    cell.appendChild(ghost);
                }
                if (selectedCell?.index === i) cell.classList.add('selected');
                cell.appendChild(numberDisplay);
                gameBoard.appendChild(cell);
            });
            checkWinCondition();
        }

        // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
        function handleCellClick(index) {
            if (selectedCell === null) {
                selectedCell = { index, value: board[index] };
            } else {
                if (selectedCell.index === index) {
                    selectedCell = null;
                } else {
                    const matchInfo = getPairMatchInfo(selectedCell, { index, value: board[index] });
                    if (matchInfo.isValid) {
                        score += Math.pow(2, matchInfo.emptyCells);
                        const [idx1, idx2] = [selectedCell.index, index];
                        ghostBoard[idx1] = board[idx1];
                        ghostBoard[idx2] = board[idx2];
                        board[idx1] = null;
                        board[idx2] = null;
                        selectedCell = null;
                        setTimeout(() => {
                            cleanupBoard();
                            updateUI();
                            renderBoard();
                            checkForPossibleMoves();
                            saveCurrentGame();
                        }, 100);
                    } else { selectedCell = null; }
                }
            }
            renderBoard();
        }

        function getPairMatchInfo(cell1, cell2) {
            const isValueMatch = cell1.value === cell2.value || cell1.value + cell2.value === 10;
            if (!isValueMatch) return { isValid: false };
            const start = Math.min(cell1.index, cell2.index), end = Math.max(cell1.index, cell2.index);
            const r1 = Math.floor(start / COLS), c1 = start % COLS;
            const r2 = Math.floor(end / COLS), c2 = end % COLS;
            let path = [];
            for (let i = start + 1; i < end; i++) if (board[i] !== null) path.push(board[i]);
            if (path.length === 0) return { isValid: true, emptyCells: end - start - 1 };
            if (c1 === c2) {
                path = [];
                for (let i = start + COLS; i < end; i += COLS) if (board[i] !== null) path.push(board[i]);
                if (path.length === 0) return { isValid: true, emptyCells: (end - start) / COLS - 1 };
            }
            if (Math.abs(r1 - r2) === Math.abs(c1 - c2)) {
                path = [];
                const step = c2 > c1 ? COLS + 1 : COLS - 1;
                for (let i = start + step; i < end; i += step) if (board[i] !== null) path.push(board[i]);
                if (path.length === 0) return { isValid: true, emptyCells: Math.abs(r1 - r2) - 1 };
            }
            return { isValid: false };
        }
        
        function cleanupBoard() {
            let newBoard = [], newGhostBoard = [];
            for (let i = 0; i < board.length; i += COLS) {
                const row = board.slice(i, i + COLS);
                if (!row.every(cell => cell === null)) {
                    newBoard.push(...row);
                    newGhostBoard.push(...ghostBoard.slice(i, i + COLS));
                }
            }
            board = newBoard;
            ghostBoard = newGhostBoard;
        }

        function addRows() {
            if (addRowsCount <= 0) return;
            const remaining = board.filter(num => num !== null);
            if (remaining.length > 0) {
                addRowsCount--;
                board.push(...remaining);
                ghostBoard = ghostBoard.concat(Array(remaining.length).fill(null));
                updateUI();
                renderBoard();
                checkForPossibleMoves();
                saveCurrentGame();
            }
        }

        function findPossibleMove() {
            const active = board.map((num, i) => ({ value: num, index: i })).filter(c => c.value !== null);
            for (let i = 0; i < active.length; i++) {
                for (let j = i + 1; j < active.length; j++) {
                    if (getPairMatchInfo(active[i], active[j]).isValid) return [active[i].index, active[j].index];
                }
            }
            return null;
        }
        
        function checkForPossibleMoves() {
            const hasMoves = findPossibleMove();
            const hasNumbers = board.some(c => c !== null);
            if (!hasMoves && hasNumbers) {
                if (addRowsCount > 0) {
                    messageBox.textContent = '–ù–µ—Ç —Ö–æ–¥–æ–≤! –î–æ–±–∞–≤—å—Ç–µ –ª–∏–Ω–∏–∏.';
                } else {
                    messageBox.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!';
                    showGameOver();
                }
            } else { messageBox.textContent = ''; }
        }

        async function showHint() {
            if (hints > 0) {
                const move = findPossibleMove();
                if (move) {
                    hints--; updateUI();
                    move.forEach(index => {
                        const cell = gameBoard.querySelector(`[data-index='${index}']`);
                        if (cell) cell.classList.add('hint-glow');
                        setTimeout(() => cell?.classList.remove('hint-glow'), 1500);
                    });
                } else { messageBox.textContent = '–ü–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–µ—Ç!'; }
            } else {
                try {
                    const data = await vkBridge.send('VKWebAppShowRewardAd', { ad_unit_id: 'reward-1' });
                    if (data.result) {
                        hints++;
                        updateUI();
                        messageBox.textContent = '–í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫—É!';
                        setTimeout(()=> messageBox.textContent = '', 2000);
                    }
                } catch (error) {
                    console.log("Rewarded Ad Error:", error);
                    messageBox.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–ª–∞–º—ã';
                    setTimeout(()=> messageBox.textContent = '', 2000);
                }
            }
        }

        function checkWinCondition() {
            if (board.length > 0 && board.every(num => num === null)) {
                board = []; ghostBoard = [];
            }
            if (board.length === 0) setTimeout(startNewLevel, 500);
        }
        
        async function showGameOver() {
            if (score > stats.bestScore) stats.bestScore = score;
            await saveData('numberzillaStats', stats);
            await saveData('savedGameState', null);
            finalScoreDisplay.textContent = score;
            gameOverModal.classList.add('visible');
        }

        // --- –°–æ–±—ã—Ç–∏—è ---
        addRowsBtn.addEventListener('click', addRows);
        restartBtn.addEventListener('click', () => initGame(true));
        hintBtn.addEventListener('click', showHint);
        helpBtn.addEventListener('click', () => instructionsModal.classList.add('visible'));
        statsBtn.addEventListener('click', () => {
            updateStatsModal();
            statsModal.classList.add('visible');
        });
        closeStatsBtn.addEventListener('click', () => statsModal.classList.remove('visible'));
        closeInstructionsBtn.addEventListener('click', () => instructionsModal.classList.remove('visible'));
        playAgainBtn.addEventListener('click', async () => {
            try {
                await vkBridge.send('VKWebAppShowInterstitialAd');
            } catch (e) {
                console.log(e);
            } finally {
                initGame(true);
            }
        });
        continueBtn.addEventListener('click', async () => {
            const savedState = await loadData('savedGameState');
            if (savedState) loadGameState(savedState);
            continueGameModal.classList.remove('visible');
        });
        startNewBtn.addEventListener('click', () => {
            initGame(true);
            continueGameModal.classList.remove('visible');
        });

        // --- –ì–ª–∞–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ ---
        async function main() {
            await loadStats();
            const savedState = await loadData('savedGameState');
            if (savedState && savedState.board.length > 0) {
                continueGameModal.classList.add('visible');
            } else {
                initGame();
            }
        }

        main();
    </script>
</body>
</html>
