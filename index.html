<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∏—Å–ª–æ–≤–∞—è –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #8B5A2B;
            touch-action: manipulation;
            overflow: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        }
        #game-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
        }
        #game-container {
            background: linear-gradient(135deg, #F9EFE6 0%, #FDFBF8 100%);
            border: 1px solid #EFE8E1;
        }
        .grid-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1rem, 5vw, 1.5rem); /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease-in-out;
            background-color: #FDFBF8;
            border-radius: 6px;
            border: 1px solid #EFE8E1;
        }
        .grid-cell.empty {
            cursor: default;
            opacity: 0;
            pointer-events: none;
            background-color: transparent;
            border: none;
        }
        .grid-cell.selected {
            background-color: #FCE9D7;
            transform: scale(1.05);
            box-shadow: 0 0 0 2px #E5B98F;
        }
        .grid-cell:not(.empty):hover {
            background-color: #F5E9DD;
        }
        .btn-icon {
            background-color: #EFE8E1;
            color: #8B5A2B;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            position: relative;
        }
        .btn-icon:hover {
            background-color: #E5DCD1;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.1);
        }
        .btn-icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .fade-out { animation: fadeOut 0.4s forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.5); } }
        
        .row-remove { animation: shrinkOut 0.5s forwards; }
        @keyframes shrinkOut { from { transform: scaleY(1); opacity: 1; } to { transform: scaleY(0); opacity: 0; height: 0; margin:0; padding: 0; border: 0;} }

        .new-cell-anim { animation: popIn 0.5s ease-out forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.7); } to { opacity: 1; transform: scale(1); } }
        
        .hint-glow { animation: glow 1.5s ease-in-out 2; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 0 2px #F9A826; } 50% { box-shadow: 0 0 15px 5px #F9A826; } }
        
        .win-message { animation: fadeIn 1s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ç—É–ª—Ç–∏–ø–æ–≤ */
        #tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body class="flex items-center justify-center p-2 sm:p-4">
    <div id="game-wrapper" class="w-full max-w-md mx-auto">
        <header class="text-center mb-2 sm:mb-4 flex justify-between items-center px-1">
            <h1 id="stage-title" class="text-xl sm:text-2xl font-bold text-[#D99B66]">–≠—Ç–∞–ø 1</h1>
            <div class="text-lg sm:text-xl font-bold text-[#D99B66]">–û—á–∫–∏: <span id="score">0</span></div>
        </header>

        <main id="game-container" class="rounded-lg p-1 sm:p-1.5 shadow-sm flex-grow overflow-y-auto">
            <div id="game-board" class="grid grid-cols-9 gap-1 sm:gap-1.5">
                <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã JavaScript -->
            </div>
        </main>
        
        <div id="message-box" class="text-center h-6 sm:h-8 my-2 sm:my-4 text-base sm:text-lg font-semibold text-red-500"></div>

        <footer class="flex justify-around items-center mt-2 sm:mt-4">
            <button id="restart-btn" data-tooltip="–ó–∞–Ω–æ–≤–æ" class="w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center rounded-xl sm:rounded-2xl btn-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 sm:w-8 sm:h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
            </button>
            <button id="hint-btn" data-tooltip="–ü–æ–¥—Å–∫–∞–∑–∫–∞" class="relative w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center rounded-xl sm:rounded-2xl text-3xl sm:text-4xl btn-icon">
                üí°
                <div id="hint-counter" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 sm:h-6 sm:w-6 flex items-center justify-center border-2 border-white">5</div>
            </button>
            <button id="add-rows-btn" data-tooltip="–î–æ–±–∞–≤–∏—Ç—å –ª–∏–Ω–∏–∏" class="relative w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center rounded-xl sm:rounded-2xl btn-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 sm:w-9 sm:h-9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <div id="add-rows-counter" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 sm:h-6 sm:w-6 flex items-center justify-center border-2 border-white">3</div>
            </button>
        </footer>
    </div>
    <div id="tooltip"></div>

    <script>
        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const gameBoard = document.getElementById('game-board');
        const addRowsBtn = document.getElementById('add-rows-btn');
        const restartBtn = document.getElementById('restart-btn');
        const hintBtn = document.getElementById('hint-btn');
        const messageBox = document.getElementById('message-box');
        const stageTitle = document.getElementById('stage-title');
        const scoreDisplay = document.getElementById('score');
        const hintCounterDisplay = document.getElementById('hint-counter');
        const addRowsCounterDisplay = document.getElementById('add-rows-counter');
        const tooltip = document.getElementById('tooltip');

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ---
        let board = [];
        let selectedCell = null;
        const COLS = 9;
        let stage = 1, score = 0, hints = 5, addRowsCount = 3;

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        function generateNumbers(count) {
            return Array.from({ length: count }, () => Math.floor(Math.random() * 9) + 1);
        }

        function initGame() {
            board = generateNumbers(31);
            selectedCell = null;
            stage = 1; score = 0; hints = 5; addRowsCount = 3;
            
            stageTitle.textContent = `–≠—Ç–∞–ø ${stage}`;
            messageBox.textContent = '';
            updateUI();
            renderBoard();
            checkForPossibleMoves();
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ---
        function updateUI() {
            scoreDisplay.textContent = score;
            hintCounterDisplay.textContent = hints;
            addRowsCounterDisplay.textContent = addRowsCount;
            hintBtn.disabled = hints <= 0;
            addRowsBtn.disabled = addRowsCount <= 0;
        }

        // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª—è ---
        function renderBoard() {
            gameBoard.innerHTML = '';
            board.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.dataset.index = index;
                cell.classList.add('grid-cell');
                
                if (num === null) {
                    cell.classList.add('empty');
                } else {
                    cell.textContent = num;
                    cell.addEventListener('click', () => handleCellClick(index));
                }

                if (selectedCell?.index === index) {
                    cell.classList.add('selected');
                }
                gameBoard.appendChild(cell);
            });
            checkWinCondition();
        }

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ ---
        function handleCellClick(index) {
            if (selectedCell === null) {
                selectedCell = { index, value: board[index] };
                renderBoard();
            } else {
                if (selectedCell.index === index) {
                    selectedCell = null;
                    renderBoard();
                    return;
                }

                const matchInfo = getPairMatchInfo(selectedCell, { index, value: board[index] });

                if (matchInfo.isValid) {
                    score += Math.pow(2, matchInfo.emptyCells);
                    
                    const [idx1, idx2] = [selectedCell.index, index];
                    const cellEl1 = gameBoard.querySelector(`[data-index='${idx1}']`);
                    const cellEl2 = gameBoard.querySelector(`[data-index='${idx2}']`);
                    
                    if(cellEl1) cellEl1.classList.add('fade-out');
                    if(cellEl2) cellEl2.classList.add('fade-out');
                    
                    board[idx1] = null;
                    board[idx2] = null;
                    selectedCell = null;
                    
                    setTimeout(() => {
                        cleanupBoard();
                        updateUI();
                        renderBoard();
                        checkForPossibleMoves();
                    }, 400);
                } else {
                    selectedCell = null;
                    renderBoard();
                }
            }
        }

        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—ã ---
        function getPairMatchInfo(cell1, cell2) {
            const isValueMatch = cell1.value === cell2.value || cell1.value + cell2.value === 10;
            if (!isValueMatch) return { isValid: false };

            const start = Math.min(cell1.index, cell2.index);
            const end = Math.max(cell1.index, cell2.index);
            const r1 = Math.floor(start / COLS), c1 = start % COLS;
            const r2 = Math.floor(end / COLS), c2 = end % COLS;

            // –ü—É—Ç—å 1: –õ–∏–Ω–µ–π–Ω—ã–π (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –∏ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º)
            let path = [];
            for (let i = start + 1; i < end; i++) {
                if (board[i] !== null) path.push(board[i]);
            }
            if (path.length === 0) return { isValid: true, emptyCells: end - start - 1 };

            // –ü—É—Ç—å 2: –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π
            if (c1 === c2) {
                path = [];
                for (let i = start + COLS; i < end; i += COLS) {
                    if (board[i] !== null) path.push(board[i]);
                }
                if (path.length === 0) return { isValid: true, emptyCells: (end - start) / COLS - 1 };
            }
            
            // –ü—É—Ç—å 3: –î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π
            if (Math.abs(r1 - r2) === Math.abs(c1 - c2)) {
                path = [];
                const step = c2 > c1 ? COLS + 1 : COLS - 1;
                for (let i = start + step; i < end; i += step) {
                    if (board[i] !== null) path.push(board[i]);
                }
                if (path.length === 0) return { isValid: true, emptyCells: Math.abs(r1 - r2) - 1 };
            }

            return { isValid: false };
        }
        
        // --- –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Ä—è–¥–æ–≤ ---
        function cleanupBoard() {
            let newBoard = [];
            for (let i = 0; i < board.length; i += COLS) {
                const row = board.slice(i, i + COLS);
                if (!row.every(cell => cell === null)) {
                    newBoard.push(...row);
                }
            }
            board = newBoard;
        }

        // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π ---
        function addRows() {
            if (addRowsCount <= 0) return;
            const remaining = board.filter(num => num !== null);
            if (remaining.length > 0) {
                addRowsCount--;
                board.push(...remaining);
                stage++;
                stageTitle.textContent = `–≠—Ç–∞–ø ${stage}`;
                updateUI();
                renderBoard();
                checkForPossibleMoves();
            }
        }

        // --- –ü–æ–¥—Å–∫–∞–∑–∫–∞ ---
        function findPossibleMove() {
            const active = board.map((num, i) => ({ value: num, index: i })).filter(c => c.value !== null);
            for (let i = 0; i < active.length; i++) {
                for (let j = i + 1; j < active.length; j++) {
                    if (getPairMatchInfo(active[i], active[j]).isValid) {
                        return [active[i].index, active[j].index];
                    }
                }
            }
            return null;
        }
        
        function checkForPossibleMoves() {
            messageBox.textContent = !findPossibleMove() && board.some(c => c !== null) ? '–ù–µ—Ç —Ö–æ–¥–æ–≤!' : '';
        }

        function showHint() {
            if (hints <= 0) return;
            const move = findPossibleMove();
            if (move) {
                hints--;
                updateUI();
                move.forEach(index => {
                    const cell = gameBoard.querySelector(`[data-index='${index}']`);
                    if (cell) cell.classList.add('hint-glow');
                    setTimeout(() => cell?.classList.remove('hint-glow'), 1500);
                });
            } else {
                 messageBox.textContent = '–ü–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–µ—Ç!';
            }
        }

        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã ---
        function checkWinCondition() {
            if (board.length > 0 && board.every(num => num === null)) {
                board = []; // –û—á–∏—â–∞–µ–º –¥–æ—Å–∫—É –ø–æ–ª–Ω–æ—Å—Ç—å—é
            }
            if (board.length === 0) {
                messageBox.innerHTML = '<span class="text-green-500 win-message">–ü–æ–±–µ–¥–∞! üéâ</span>';
            }
        }

        // --- –¢—É–ª—Ç–∏–ø—ã ---
        document.querySelectorAll('[data-tooltip]').forEach(el => {
            el.addEventListener('mouseenter', e => {
                tooltip.textContent = e.target.closest('[data-tooltip]').dataset.tooltip;
                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2}px`;
                tooltip.style.top = `${rect.top - 10}px`;
                tooltip.style.transform = 'translate(-50%, -100%)';
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
            });
            el.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
            });
        });

        // --- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π ---
        addRowsBtn.addEventListener('click', addRows);
        restartBtn.addEventListener('click', initGame);
        hintBtn.addEventListener('click', showHint);

        // --- –ó–∞–ø—É—Å–∫ ---
        initGame();
    </script>
</body>
</html>
